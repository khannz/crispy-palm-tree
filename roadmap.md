# NLB info

Общая информация о програмном сетевом балансировщике.

## Фичи

1. Балансировщик: детектирование настроенных сервисов.
    + Основываясь на keepalived файле получать данные о всех текущих сервисах, по каждому сервису выдача информации: ip+port сервиса, список серверов обработки (ip+port для каждого), тип healthcheck.

2. Балансировщик: модификация серверов обработки данных по запросу.
    + Возможность добавлять и удалять сервера обработки данных. Запрос на добавление/удаление серверов обработки содержит в себе ip+port сервиса и список серверов обработки (ip+port для каждого). Дополнительно: отказ при удалении всех (или последнего) серверов обработки. Удаление сервиса должно идти через другой запрос.

3. Балансировщик: генерация команд настройки для серверов обработки.
    + В ответ на запросы добавление/удаление серверов обоработки, создание/удаление сервиса в поле "realServersConfigure" должен добавиться массив команд (формата bash) для настроки серверов обработки.

4. Балансировщик: выдавать данные о загрузке.
    + Данные: CPU, сессии в секунду, нагрузка сети.

5. Контроллер: разработать контроллер для балансировщиков с базовым функционалом.
    + Регистрировать и удалять балансировщики, вести их учёт.
    + Принимать json по rest api (то же что и для балансировщика) и передавать его далее на балансировщик.

6. Контроллер: доработка контроллера балансировщиков (разбить на истории, требует уточнений).
    + Мониторинг баланисировщиков (статус работы).
    + Получение информации о загрузке балансировщкиа загрузка(CPU+network(сессии в сек)).
    + Хранение информации о зонах безопасости, автоматизированный выбор/развертование балансировщика на их основе.

7. Балансировщик: реализация холодного и обычного запуска.
    + При холодном запуске генерация дополнительной конфигурации + то же что и для обычного запуска:
        1. Конфигурация dummy (генерирование настроек для *modprobe.d/dummy.conf и *modules-load.d/dummy.conf)
        2. Конфигурация тунелей (генерирование настроек для *modules-load.d/tunnel.conf)
        3. Проверка наличие сервиса keepalived.
        4. Включение сервиса keepalived (enabled + run).
        5. Регистрация в контроллере.
    + При обычном запуске:
        1. Валидность конфигурации dummy (в *modprobe.d/dummy.conf и *modules-load.d/dummy.conf).
        2. Валидность конфигурации тунелей (в *modules-load.d/tunnel.conf)
        3. Проверка статуса сервиса keepalived (enabled + run).

8. Балансировщик: возможность выбора типа healthcheck: icmp/tcp/http. (фича требует уточнений)

## Tаски

1. Удаление сервиса должно выполняться только на основании данных о сервисе (ip+port).

2. Расширить формат ответа на запрос. В ответе должны содержаться конкретные данные.
Пример ответа:

```json
{
  "jobUUID": "7a7aebea-4e05-45b9-8d11-c4115dbdd4a2",
  "realServersData": {
    "1.1.1.1": "11",
    "2.2.2.2": "22"
  },
  "realServersCommands": {
      "1.1.1.1:11": "#!/bin/bash\nifconfig lo:10 9.9.9.9 netmask 255.255.255.255 -arp up\nifconfig tun100 up\nsysctl -w net.ipv4.conf.tun100.rp_filter=0\nsysctl -w net.ipv4.conf.all.rp_filter=0\nnet.ipv4.ip_forward = 0\niptables -t nat -A PREROUTING -i tun100 -p tcp -d 1.1.1.1 --dport 11 -j DNAT --to-destination 9.9.9.9:999",
      "2.2.2.2:22": "#!/bin/bash\nifconfig lo:10 9.9.9.9 netmask 255.255.255.255 -arp up\nifconfig tun100 up\nsysctl -w net.ipv4.conf.tun100.rp_filter=0\nsysctl -w net.ipv4.conf.all.rp_filter=0\nnet.ipv4.ip_forward = 0\niptables -t nat -A PREROUTING -i tun100 -p tcp -d 2.2.2.2 --dport 22 -j DNAT --to-destination 9.9.9.9:999"
  },
  "serviceIP": "9.9.9.9",
  "servicePort": "999",
  "healthcheckType": "tcp",
  "jobCompletedSuccessfully": true
}
```
